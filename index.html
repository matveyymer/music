<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Музыкальный плеер — Google Drive</title>

<script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>
<script src="https://apis.google.com/js/api.js"></script>

<style>
:root {
  --bg: #fff;
  --text: #111;
  --muted: #666;
  --accent: #000;
  --outline: rgba(0,0,0,0.12);
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", Inter, sans-serif;
}
body {
  margin: 0;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  background: var(--bg);
  color: var(--text);
  overflow: hidden;
}
nav {
  display: flex;
  justify-content: space-around;
  border-top: 1px solid var(--outline);
  padding: 12px 0;
  position: fixed;
  bottom: 0;
  width: 100%;
  background: var(--bg);
}
nav button {
  border: none;
  background: none;
  font-size: 14px;
  cursor: pointer;
  color: var(--text);
  opacity: 0.7;
}
nav button.active {
  opacity: 1;
  font-weight: 600;
}
.view {
  display: none;
  flex: 1;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 20px;
  overflow-y: auto;
  margin-bottom: 60px;
}
.view.active {
  display: flex;
}

/* квадратные обложки */
.cover {
  width: min(80vw, 320px);
  aspect-ratio: 1 / 1;
  background: #f3f3f3;
  margin-top: 24px;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 8px 20px rgba(0,0,0,0.08);
  display: flex;
  align-items: center;
  justify-content: center;
}
.cover img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.title {
  font-size: 18px;
  font-weight: 600;
  margin-top: 12px;
  text-align: center;
  max-width: 90%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.artist {
  font-size: 13px;
  color: var(--muted);
  margin-top: 4px;
}
.progress {
  width: 80%;
  height: 6px;
  background: rgba(0,0,0,0.08);
  border-radius: 999px;
  margin: 16px 0;
  cursor: pointer;
}
.bar {
  height: 100%;
  width: 0%;
  background: var(--accent);
  border-radius: inherit;
}
.time {
  width: 80%;
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  color: var(--muted);
}
.controls {
  display: flex;
  gap: 24px;
  align-items: center;
  margin-top: 14px;
}
button.control {
  background: var(--bg);
  border: 1px solid var(--outline);
  border-radius: 50%;
  width: 60px;
  height: 60px;
  font-size: 20px;
  cursor: pointer;
}
button.play {
  width: 80px;
  height: 80px;
  font-size: 26px;
}
.library {
  width: 100%;
  padding: 14px 20px 120px;
  box-sizing: border-box;
  display: grid;
  gap: 16px;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
}
.track-card {
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}
.track-card img {
  width: 100%;
  aspect-ratio: 1 / 1;
  object-fit: cover;
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.06);
}
.track-card .info {
  width: 100%;
  margin-top: 8px;
}
.track-card .title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.track-card .artist {
  font-size: 12px;
  color: var(--muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.settings {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
  padding: 20px;
}
.settings button {
  padding: 12px 20px;
  font-size: 15px;
  border: 1px solid var(--outline);
  border-radius: 8px;
  background: var(--bg);
  cursor: pointer;
}
</style>
</head>

<body>
<div class="view active" id="now">
  <div class="cover" id="cover-now"><img id="cover-img" src="" alt="Обложка"></div>
  <div class="title" id="now-title">Нет трека</div>
  <div class="artist" id="now-artist">—</div>
  <div class="progress"><div class="bar" id="bar"></div></div>
  <div class="time"><span id="time-current">0:00</span><span id="time-total">0:00</span></div>
  <div class="controls">
    <button class="control" id="prev">⏮</button>
    <button class="control play" id="play">▶</button>
    <button class="control" id="next">⏭</button>
  </div>
  <audio id="player"></audio>
</div>

<div class="view" id="library">
  <input type="file" id="fileInput" multiple accept="audio/*" />
  <div class="library" id="tracks"></div>
</div>

<div class="view" id="settings">
  <div class="cover"><img src="https://i.imgur.com/Zz4upOq.png" alt="Обложка" /></div>
  <div class="settings">
    <button id="connectDrive">Подключить Google Drive</button>
    <button id="uploadDrive">Загрузить треки в Drive</button>
  </div>
</div>

<nav>
  <button class="active" data-view="now">Сейчас играет</button>
  <button data-view="library">Библиотека</button>
  <button data-view="settings">Настройки</button>
</nav>

<script>
const CLIENT_ID = "215344556129-r6crslrt9iu44jl4gvfp32mc985p204n.apps.googleusercontent.com";
let token = null;

const views = document.querySelectorAll('.view');
const navButtons = document.querySelectorAll('nav button');
const player = document.getElementById('player');
const bar = document.getElementById('bar');
const nowTitle = document.getElementById('now-title');
const nowArtist = document.getElementById('now-artist');
const coverImg = document.getElementById('cover-img');
let currentTrack = 0;
let tracks = [];

// переключение вкладок
navButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    navButtons.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    views.forEach(v => v.classList.remove('active'));
    document.getElementById(btn.dataset.view).classList.add('active');
  });
});

// загрузка треков
document.getElementById('fileInput').addEventListener('change', e => {
  const files = [...e.target.files];
  files.forEach(file => {
    jsmediatags.read(file, {
      onSuccess: tag => {
        const title = tag.tags.title || file.name;
        const artist = tag.tags.artist || 'Неизвестный';
        let imgUrl = '';
        if (tag.tags.picture) {
          const data = tag.tags.picture.data;
          const format = tag.tags.picture.format;
          const base64 = btoa(String.fromCharCode(...data));
          imgUrl = `data:${format};base64,${base64}`;
        }
        tracks.push({ file, title, artist, imgUrl });
        updateLibrary();
      },
      onError: () => {
        tracks.push({ file, title: file.name, artist: '—', imgUrl: '' });
        updateLibrary();
      }
    });
  });
});

function updateLibrary() {
  const lib = document.getElementById('tracks');
  lib.innerHTML = '';
  tracks.forEach((t, i) => {
    const div = document.createElement('div');
    div.className = 'track-card';
    div.innerHTML = `
      <img src="${t.imgUrl || 'https://i.imgur.com/Zz4upOq.png'}" alt="">
      <div class="info">
        <div class="title">${t.title}</div>
        <div class="artist">${t.artist}</div>
      </div>`;
    div.onclick = () => playTrack(i);
    lib.appendChild(div);
  });
}

function playTrack(i) {
  const t = tracks[i];
  currentTrack = i;
  nowTitle.textContent = t.title;
  nowArtist.textContent = t.artist;
  coverImg.src = t.imgUrl || 'https://i.imgur.com/Zz4upOq.png';
  player.src = URL.createObjectURL(t.file);
  player.play();
  document.getElementById('play').textContent = '⏸';
}

document.getElementById('play').addEventListener('click', () => {
  if (player.paused) {
    player.play();
    document.getElementById('play').textContent = '⏸';
  } else {
    player.pause();
    document.getElementById('play').textContent = '▶';
  }
});

player.ontimeupdate = () => {
  if (player.duration) bar.style.width = `${(player.currentTime / player.duration) * 100}%`;
};

// Google Drive
function loadGapi() {
  gapi.load("client:picker", async () => {
    await gapi.client.init({
      clientId: CLIENT_ID,
      discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
      scope: "https://www.googleapis.com/auth/drive.file"
    });
  });
}
loadGapi();

document.getElementById('connectDrive').onclick = async () => {
  const GoogleAuth = gapi.auth2.getAuthInstance();
  const user = await GoogleAuth.signIn();
  token = user.getAuthResponse().access_token;
  alert("Google Drive подключен!");
};

document.getElementById('uploadDrive').onclick = async () => {
  if (!token) return alert("Сначала подключи Google Drive");
  for (const t of tracks) {
    const form = new FormData();
    form.append("metadata", new Blob([JSON.stringify({
      name: t.title, mimeType: "audio/mpeg"
    })], { type: "application/json" }));
    form.append("file", t.file);
    await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
      method: "POST",
      headers: { Authorization: "Bearer " + token },
      body: form
    });
  }
  alert("Треки загружены в Google Drive!");
};
</script>
</body>
</html>